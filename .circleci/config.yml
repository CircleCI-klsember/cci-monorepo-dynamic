version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@0.1.1
  continuation: circleci/continuation@0.2.0

jobs:
  Get_Target_Branch:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - run:
          name: Get Target Branch
          command: |
            if [[ -n $CIRCLE_PULL_REQUEST ]]; then
              echo $CIRCLE_PULL_REQUEST
              echo 'export GH_API_URL=$(echo $CIRCLE_PULL_REQUEST | sed "s|github.com/klsember/$CIRCLE_PROJECT_REPONAME/pull|api.github.com/repos/klsember/$CIRCLE_PROJECT_REPONAME/pulls|g")' >> $BASH_ENV
            fi
      - run: echo ${GHAPI_URL}
      - run: 
          command: |
              curl $GH_API_URL | jq '.base.ref' | tr -d '"' > Targetbranch.txt
              echo 'export TARGET_BRANCH=$(<Targetbranch.txt)' >> $BASH_ENV; source $BASH_ENV
      - run: echo 'export BASE_REVISION=$TARGET_BRANCH' >> $BASH_ENV
      - run:
          environment:
            MAPPING: |
              api/.* run-api-workflow true
              app/.* run-app-workflow true
              auth/.* run-auth-workflow true
              gateway/.* run-gateway-workflow true
            OUTPUT_PATH: "/tmp/pipeline-parameters.json"
          name: Set parameters
          shell: /usr/bin/env python3
          command: |+
              #!/usr/bin/env python3
              import os
              import subprocess
              import json
              
              output = subprocess.check_output(os.environ('BASH_ENV'), shell=True)
              # Parse the `printenv` output
              exported_vars = dict(
                  line.split("=", 1)
                  for line in output.decode().splitlines()
                  if line
              )
              # Filter to keep only variables that have new or changed values
              changed_vars = {
                  key: value
                  for (key, value) in exported_vars.items()
                  if value != os.environ.get(key)
              }
              pprint.pprint(changed_vars)
              print(os.environ.get('TARGET_BRANCH'))
      #- continuation/continue:
      #    configuration_path: .circleci/dynamic_config.yml
    
workflows:
  setup:
    jobs:
      - Get_Target_Branch:
          context:
            - GitHub
