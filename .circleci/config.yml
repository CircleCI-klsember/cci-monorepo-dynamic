version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@0.1.1
  continuation: circleci/continuation@0.2.0

jobs:
  Get_Target_Branch:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - run: mkdir -p workspace
      - run:
          name: Get Target Branch
          command: |
            if [[ -n $CIRCLE_PULL_REQUEST ]]; then
              echo $CIRCLE_PULL_REQUEST
              echo 'export GH_API_URL=$(echo $CIRCLE_PULL_REQUEST | sed "s|github.com/klsember/$CIRCLE_PROJECT_REPONAME/pull|api.github.com/repos/klsember/$CIRCLE_PROJECT_REPONAME/pulls|g")' >> $BASH_ENV
              source $BASH_ENV
              curl $GH_API_URL | jq '.base.ref' | tr -d '"' > Targetbranch.txt
              echo 'export TARGET_BRANCH=$(<Targetbranch.txt)' >> $BASH_ENV
            fi
      - run: 
          name: Exporting Variables
          command: |
            echo "export GHAPI_URL=$GH_API_URL" >> workspace/new-env-vars
            echo "export GHTARGET_BRANCH=$TARGET_BRANCH" >> workspace/new-env-vars
      - run: cat workspace/new-env-vars >> $BASH_ENV
      - run: echo ${GHAPI_URL}
      - run: echo ${GHTARGET_BRANCH}
      - persist_to_workspace:
          root: workspace
          paths:
            - new-env-vars
  pr-pathfiltering:
    docker:
      - image: cimg/python:3.8
    resource_class: small
    steps:
      - attach_workspace:
          at: ~/workspace
      - run: cat /home/circleci/workspace/new-env-vars >> $BASH_ENV
      - run: echo $GHTARGET_BRANCH
      #- checkout
      #- path-filtering/set-parameters:
      #    base-revision: ${TARGET_BRANCH}
      #    mapping: |
      #      api/.* run-api-workflow true
      #      app/.* run-app-workflow true
      #      auth/.* run-auth-workflow true
      #      gateway/.* run-gateway-workflow true
      #- continuation/continue:
      #    configuration_path: .circleci/dynamic_config.yml
    

workflows:
  setup:
    jobs:
      - Get_Target_Branch:
          context:
            - GitHub
      - pr-pathfiltering:
          requires:
            - Get_Target_Branch
